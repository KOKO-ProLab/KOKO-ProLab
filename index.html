<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fule Online - فيول أونلاين</title>
    <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .balance-display {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
        }

        .nav-menu {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .theme-toggle {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-1 {
            grid-template-columns: 1fr;
        }

        @media (max-width: 1024px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-3, .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .nav-menu {
                justify-content: center;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--bg-secondary);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: var(--shadow);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-color: var(--success);
            background: #dcfce7;
            color: #166534;
        }

        .toast.error {
            border-color: var(--error);
            background: #fef2f2;
            color: #991b1b;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background: #dcfce7;
            color: #166534;
        }

        .status-cancelled {
            background: #fef2f2;
            color: #991b1b;
        }

        /* Footer */
        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .footer-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Hidden sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Admin Panel */
        .admin-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .admin-tab {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .admin-tab.active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Product grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .product-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .product-price {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
            margin: 1rem 0;
        }

        .product-type {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        /* Currency selector */
        .currency-selector {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .currency-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .currency-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Order tracking */
        .order-timeline {
            position: relative;
            padding-right: 2rem;
        }

        .order-step {
            position: relative;
            padding-bottom: 2rem;
        }

        .order-step::before {
            content: '';
            position: absolute;
            right: -1rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border);
        }

        .order-step.completed::before {
            background: var(--success);
        }

        .order-step.active::before {
            background: var(--primary);
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .footer-stats {
                flex-direction: column;
                gap: 1rem;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
        }

        /* SVG Icons */
        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">Fule Online</div>
                
                <div class="balance-display" id="balanceDisplay">
                    الرصيد: <span id="userBalance">0</span> <span id="balanceCurrency">USD</span>
                </div>
                
                <nav class="nav-menu">
                    <button class="nav-btn active" onclick="showSection('products')">المنتجات</button>
                    <button class="nav-btn" onclick="showSection('orders')">الطلبات</button>
                    <button class="nav-btn" onclick="showSection('profile')">الملف الشخصي</button>
                    <button class="nav-btn" onclick="showSection('deposit')">إيداع</button>
                    <button class="nav-btn" id="adminBtn" onclick="showSection('admin')" style="display: none;">لوحة الإدارة</button>
                </nav>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="currency-selector">
                        <button class="currency-btn active" onclick="changeCurrency('USD')">USD</button>
                        <button class="currency-btn" onclick="changeCurrency('EGP')">EGP</button>
                    </div>
                    
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </button>
                    
                    <button class="btn btn-outline" onclick="logout()" id="logoutBtn" style="display: none;">تسجيل الخروج</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Auth Section -->
        <section id="auth" class="section active">
            <div class="grid grid-1" style="max-width: 400px; margin: 4rem auto;">
                <div class="card">
                    <div class="card-title">تسجيل الدخول / إنشاء حساب</div>
                    
                    <div id="authTabs" class="nav-menu" style="margin-bottom: 2rem;">
                        <button class="nav-btn active" onclick="switchAuthTab('login')">تسجيل الدخول</button>
                        <button class="nav-btn" onclick="switchAuthTab('signup')">إنشاء حساب</button>
                        <button class="nav-btn" onclick="switchAuthTab('reset')">استعادة كلمة المرور</button>
                    </div>
                    
                    <form id="loginForm">
                        <div class="form-group">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-input" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" class="form-input" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span class="loading" id="loginLoading" style="display: none;"></span>
                            تسجيل الدخول
                        </button>
                    </form>
                    
                    <form id="signupForm" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">اسم المستخدم (لا يمكن تغييره)</label>
                            <input type="text" class="form-input" id="signupUsername" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">الاسم المعروض</label>
                            <input type="text" class="form-input" id="signupDisplayName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-input" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" class="form-input" id="signupPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span class="loading" id="signupLoading" style="display: none;"></span>
                            إنشاء حساب
                        </button>
                    </form>
                    
                    <form id="resetForm" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-input" id="resetEmail" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span class="loading" id="resetLoading" style="display: none;"></span>
                            إرسال رابط الاستعادة
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Products Section -->
        <section id="products" class="section">
            <div class="card-title">المنتجات المتاحة</div>
            <div id="productsGrid" class="product-grid">
                <!-- Products will be loaded here -->
            </div>
        </section>

        <!-- Orders Section -->
        <section id="orders" class="section">
            <div class="card-title">طلباتي</div>
            <div id="ordersContainer">
                <!-- Orders will be loaded here -->
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title">معلومات الحساب</div>
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">اسم المستخدم</label>
                            <input type="text" class="form-input" id="profileUsername" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">الاسم المعروض</label>
                            <input type="text" class="form-input" id="profileDisplayName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-input" id="profileEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">الدور</label>
                            <input type="text" class="form-input" id="profileRole" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">حالة التحقق</label>
                            <span id="profileVerified" class="status-badge">غير محقق</span>
                        </div>
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-title">إحصائيات الحساب</div>
                    <div class="stat-item">
                        <div class="stat-number" id="userOrdersCount">0</div>
                        <div class="stat-label">إجمالي الطلبات</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Deposit Section -->
        <section id="deposit" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title">إيداع عملات رقمية</div>
                    <form id="cryptoDepositForm">
                        <div class="form-group">
                            <label class="form-label">نوع العملة</label>
                            <select class="form-select" id="cryptoType">
                                <option value="BTC">Bitcoin (BTC)</option>
                                <option value="ETH">Ethereum (ETH)</option>
                                <option value="USDT">Tether (USDT)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">المبلغ</label>
                            <input type="number" class="form-input" id="cryptoAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">عنوان المحفظة</label>
                            <input type="text" class="form-input" id="cryptoWallet" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span class="loading" id="cryptoLoading" style="display: none;"></span>
                            إيداع عملات رقمية
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-title">إيداع فودافون كاش</div>
                    <form id="vodafoneDepositForm">
                        <div class="form-group">
                            <label class="form-label">رقم الهاتف</label>
                            <input type="tel" class="form-input" id="vodafonePhone" placeholder="01xxxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">المبلغ (جنيه مصري)</label>
                            <input type="number" class="form-input" id="vodafoneAmount" min="10" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">رقم العملية</label>
                            <input type="text" class="form-input" id="vodafoneTransaction" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span class="loading" id="vodafoneLoading" style="display: none;"></span>
                            إيداع فودافون كاش
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" class="section">
            <div class="admin-panel">
                <div class="card-title">لوحة الإدارة</div>
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchAdminTab('products')">إدارة المنتجات</button>
                    <button class="admin-tab" onclick="switchAdminTab('orders')">إدارة الطلبات</button>
                    <button class="admin-tab" onclick="switchAdminTab('users')">إدارة المستخدمين</button>
                    <button class="admin-tab" onclick="switchAdminTab('settings')">الإعدادات</button>
                    <button class="admin-tab" onclick="switchAdminTab('stats')">الإحصائيات</button>
                </div>
            </div>
            
            <!-- Admin Products -->
            <div id="adminProducts" class="admin-content">
                <div class="card">
                    <div class="card-title">إضافة منتج جديد</div>
                    <form id="addProductForm">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">العنوان</label>
                                <input type="text" class="form-input" id="productTitle" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">النوع</label>
                                <select class="form-select" id="productType" required>
                                    <option value="smm">خدمات التواصل الاجتماعي</option>
                                    <option value="physical">منتج مادي</option>
                                    <option value="digital">منتج رقمي</option>
                                    <option value="request">طلب موقع</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">السعر</label>
                                <input type="number" class="form-input" id="productPrice" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">العملة</label>
                                <select class="form-select" id="productCurrency" required>
                                    <option value="USD">USD</option>
                                    <option value="EGP">EGP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">المخزون</label>
                                <input type="number" class="form-input" id="productStock" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">مرئي</label>
                                <select class="form-select" id="productVisible">
                                    <option value="true">نعم</option>
                                    <option value="false">لا</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">الوصف</label>
                            <textarea class="form-textarea" id="productDescription" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">إضافة المنتج</button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-title">المنتجات الحالية</div>
                    <div id="adminProductsList"></div>
                </div>
            </div>
            
            <!-- Admin Orders -->
            <div id="adminOrders" class="admin-content" style="display: none;">
                <div class="card">
                    <div class="card-title">إدارة الطلبات</div>
                    <div id="adminOrdersList"></div>
                </div>
            </div>
            
            <!-- Admin Users -->
            <div id="adminUsers" class="admin-content" style="display: none;">
                <div class="card">
                    <div class="card-title">إدارة المستخدمين</div>
                    <div id="adminUsersList"></div>
                </div>
            </div>
            
            <!-- Admin Settings -->
            <div id="adminSettings" class="admin-content" style="display: none;">
                <div class="card">
                    <div class="card-title">إعدادات الموقع</div>
                    <form id="siteSettingsForm">
                        <div class="form-group">
                            <label class="form-label">نص الترحيب</label>
                            <input type="text" class="form-input" id="welcomeText" value="مرحباً بك في Fule Online">
                        </div>
                        <div class="form-group">
                            <label class="form-label">وصف الموقع</label>
                            <textarea class="form-textarea" id="siteDescription">أفضل منصة للخدمات الرقمية</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                    </form>
                </div>
            </div>
            
            <!-- Admin Stats -->
            <div id="adminStats" class="admin-content" style="display: none;">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-title">تحديث الإحصائيات</div>
                        <form id="updateStatsForm">
                            <div class="form-group">
                                <label class="form-label">المستخدمين النشطين</label>
                                <input type="number" class="form-input" id="activeUsersCount" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">إجمالي الطلبات</label>
                                <input type="number" class="form-input" id="totalOrdersCount" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">طلبات اليوم</label>
                                <input type="number" class="form-input" id="dailyOrdersCount" min="0">
                            </div>
                            <button type="submit" class="btn btn-primary">تحديث الإحصائيات</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">إحصائيات حية</div>
                        <div id="liveStats"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-stats">
                <div class="stat-item">
                    <div class="stat-number" id="footerActiveUsers">33,000</div>
                    <div class="stat-label">مستخدم نشط</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="footerTotalOrders">125,000</div>
                    <div class="stat-label">إجمالي الطلبات</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="footerDailyOrders">1,250</div>
                    <div class="stat-label">طلبات اليوم</div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Order Modal -->
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; margin: 2rem;">
            <div class="card-title">تأكيد الطلب</div>
            <div id="orderModalContent"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="confirmOrder()">تأكيد الطلب</button>
                <button class="btn btn-outline" onclick="closeOrderModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCcxGOaiiy6Dy1MybOIOxn69xab4rsOOJ0",
            authDomain: "koko-caffe.firebaseapp.com",
            databaseURL: "https://koko-caffe-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "koko-caffe",
            storageBucket: "koko-caffe.firebasestorage.app",
            messagingSenderId: "382318796715",
            appId: "1:382318796715:web:ee9f3aca9a107f86da7cee",
            measurementId: "G-B83G77QPWW"
        };

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, orderBy, onSnapshot, updateDoc, deleteDoc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getDatabase, ref, set, get, onValue, update, push } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const functions = getFunctions(app);

        // Global variables
        let currentUser = null;
        let currentCurrency = 'USD';
        let selectedProduct = null;
        let userBalance = 0;

        // Make Firebase available globally
        window.auth = auth;
        window.db = db;
        window.rtdb = rtdb;
        window.functions = functions;

        // Authentication functions
        window.switchAuthTab = function(tab) {
            document.querySelectorAll('#authTabs .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#authTabs .nav-btn:nth-child(${tab === 'login' ? 1 : tab === 'signup' ? 2 : 3})`).classList.add('active');
            
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
            document.getElementById('resetForm').style.display = tab === 'reset' ? 'block' : 'none';
        };

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loading = document.getElementById('loginLoading');
            
            loading.style.display = 'inline-block';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('تم تسجيل الدخول بنجاح', 'success');
            } catch (error) {
                showToast('خطأ في تسجيل الدخول: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        });

        // Signup form handler
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signupUsername').value;
            const displayName = document.getElementById('signupDisplayName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const loading = document.getElementById('signupLoading');
            
            loading.style.display = 'inline-block';
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user document
                await setDoc(doc(db, 'users', user.uid), {
                    username: username,
                    displayName: displayName,
                    role: 'user',
                    verified: false,
                    createdAt: serverTimestamp()
                });
                
                // Initialize balance
                await set(ref(rtdb, `balances/${user.uid}`), { balance: 0 });
                
                showToast('تم إنشاء الحساب بنجاح', 'success');
            } catch (error) {
                showToast('خطأ في إنشاء الحساب: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        });

        // Reset password form handler
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            const loading = document.getElementById('resetLoading');
            
            loading.style.display = 'inline-block';
            
            try {
                await sendPasswordResetEmail(auth, email);
                showToast('تم إرسال رابط استعادة كلمة المرور', 'success');
            } catch (error) {
                showToast('خطأ في إرسال الرابط: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        });

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                showSection('products');
                document.getElementById('auth').classList.remove('active');
                document.getElementById('logoutBtn').style.display = 'block';
                loadProducts();
                loadOrders();
                loadBalance();
            } else {
                currentUser = null;
                // Show auth section and hide others
                hideAllSections();
                document.getElementById('auth').classList.add('active');
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('adminBtn').style.display = 'none';
            }
        });

        // Load user data
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // Update profile form
                    document.getElementById('profileUsername').value = userData.username || '';
                    document.getElementById('profileDisplayName').value = userData.displayName || '';
                    document.getElementById('profileEmail').value = currentUser.email || '';
                    document.getElementById('profileRole').value = userData.role || 'user';
                    document.getElementById('profileVerified').textContent = userData.verified ? 'محقق' : 'غير محقق';
                    document.getElementById('profileVerified').className = `status-badge ${userData.verified ? 'status-completed' : 'status-pending'}`;
                    
                    // Show admin button if user is admin
                    if (userData.role === 'admin') {
                        document.getElementById('adminBtn').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load balance
        function loadBalance() {
            if (!currentUser) return;
            
            const balanceRef = ref(rtdb, `balances/${currentUser.uid}`);
            onValue(balanceRef, (snapshot) => {
                const data = snapshot.val();
                userBalance = data?.balance || 0;
                updateBalanceDisplay();
            });
        }

        // Update balance display
        function updateBalanceDisplay() {
            document.getElementById('userBalance').textContent = userBalance.toFixed(2);
            document.getElementById('balanceCurrency').textContent = currentCurrency;
        }

        // Profile form handler
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const displayName = document.getElementById('profileDisplayName').value;
            
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    displayName: displayName
                });
                showToast('تم حفظ التغييرات بنجاح', 'success');
            } catch (error) {
                showToast('خطأ في حفظ التغييرات: ' + error.message, 'error');
            }
        });

        // Load products
        async function loadProducts() {
            try {
                const productsQuery = query(collection(db, 'products'), where('visible', '==', true));
                const querySnapshot = await getDocs(productsQuery);
                
                const productsGrid = document.getElementById('productsGrid');
                productsGrid.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const product = { id: doc.id, ...doc.data() };
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Create product card
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const typeLabels = {
                smm: 'خدمات التواصل الاجتماعي',
                physical: 'منتج مادي',
                digital: 'منتج رقمي',
                request: 'طلب موقع'
            };
            
            card.innerHTML = `
                <div class="product-type">${typeLabels[product.type] || product.type}</div>
                <h3>${product.title}</h3>
                <p>${product.description}</p>
                <div class="product-price">${product.price} ${product.currency}</div>
                ${product.stock !== undefined ? `<p>المتوفر: ${product.stock}</p>` : ''}
                <button class="btn btn-primary" onclick="openOrderModal('${product.id}')" style="width: 100%;">
                    طلب الآن
                </button>
            `;
            
            return card;
        }

        // Open order modal
        window.openOrderModal = async function(productId) {
            try {
                const productDoc = await getDoc(doc(db, 'products', productId));
                if (productDoc.exists()) {
                    selectedProduct = { id: productId, ...productDoc.data() };
                    
                    const modalContent = document.getElementById('orderModalContent');
                    modalContent.innerHTML = `
                        <h3>${selectedProduct.title}</h3>
                        <p>${selectedProduct.description}</p>
                        <p><strong>السعر: ${selectedProduct.price} ${selectedProduct.currency}</strong></p>
                        <div class="form-group">
                            <label class="form-label">تفاصيل إضافية</label>
                            <textarea class="form-textarea" id="orderDetails" placeholder="أدخل أي تفاصيل إضافية للطلب"></textarea>
                        </div>
                    `;
                    
                    document.getElementById('orderModal').style.display = 'flex';
                }
            } catch (error) {
                showToast('خطأ في تحميل المنتج', 'error');
            }
        };

        // Close order modal
        window.closeOrderModal = function() {
            document.getElementById('orderModal').style.display = 'none';
            selectedProduct = null;
        };

        // Confirm order
        window.confirmOrder = async function() {
            if (!selectedProduct || !currentUser) return;
            
            const details = document.getElementById('orderDetails').value;
            
            try {
                // Check balance
                if (userBalance < selectedProduct.price) {
                    showToast('الرصيد غير كافي', 'error');
                    return;
                }
                
                // Create order
                const orderData = {
                    userId: currentUser.uid,
                    productId: selectedProduct.id,
                    status: 'pending',
                    details: details,
                    price: selectedProduct.price,
                    currency: selectedProduct.currency,
                    method: 'balance',
                    createdAt: serverTimestamp(),
                    adminNotes: ''
                };
                
                const orderRef = await addDoc(collection(db, 'orders'), orderData);
                
                // Update balance
                const newBalance = userBalance - selectedProduct.price;
                await update(ref(rtdb, `balances/${currentUser.uid}`), { balance: newBalance });
                
                // Update stock if applicable
                if (selectedProduct.stock !== undefined && selectedProduct.stock > 0) {
                    await updateDoc(doc(db, 'products', selectedProduct.id), {
                        stock: selectedProduct.stock - 1
                    });
                }
                
                showToast('تم إنشاء الطلب بنجاح', 'success');
                closeOrderModal();
                loadOrders();
                
            } catch (error) {
                showToast('خطأ في إنشاء الطلب: ' + error.message, 'error');
            }
        };

        // Load orders
        async function loadOrders() {
            if (!currentUser) return;
            
            try {
                const ordersQuery = query(
                    collection(db, 'orders'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                
                onSnapshot(ordersQuery, (querySnapshot) => {
                    const ordersContainer = document.getElementById('ordersContainer');
                    ordersContainer.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        ordersContainer.innerHTML = '<p>لا توجد طلبات حتى الآن</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const order = { id: doc.id, ...doc.data() };
                        const orderCard = createOrderCard(order);
                        ordersContainer.appendChild(orderCard);
                    });
                    
                    // Update orders count
                    document.getElementById('userOrdersCount').textContent = querySnapshot.size;
                });
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Create order card
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'card';
            
            const statusLabels = {
                pending: 'في الانتظار',
                processing: 'قيد المعالجة',
                completed: 'مكتمل',
                cancelled: 'ملغي'
            };
            
            const statusClass = {
                pending: 'status-pending',
                processing: 'status-processing',
                completed: 'status-completed',
                cancelled: 'status-cancelled'
            };
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>طلب #${order.id.substring(0, 8)}</h3>
                    <span class="status-badge ${statusClass[order.status]}">${statusLabels[order.status]}</span>
                </div>
                <p><strong>السعر:</strong> ${order.price} ${order.currency}</p>
                <p><strong>التفاصيل:</strong> ${order.details || 'لا توجد تفاصيل'}</p>
                <p><strong>تاريخ الإنشاء:</strong> ${order.createdAt?.toDate?.()?.toLocaleDateString('ar-EG') || 'غير محدد'}</p>
                ${order.adminNotes ? `<p><strong>ملاحظات الإدارة:</strong> ${order.adminNotes}</p>` : ''}
            `;
            
            return card;
        }

        // Deposit functions
        document.getElementById('cryptoDepositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const type = document.getElementById('cryptoType').value;
            const amount = parseFloat(document.getElementById('cryptoAmount').value);
            const wallet = document.getElementById('cryptoWallet').value;
            const loading = document.getElementById('cryptoLoading');
            
            loading.style.display = 'inline-block';
            
            try {
                // In a real implementation, this would call a Cloud Function
                // For demo purposes, we'll simulate the deposit
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showToast('تم إرسال طلب الإيداع، سيتم المراجعة قريباً', 'success');
                document.getElementById('cryptoDepositForm').reset();
            } catch (error) {
                showToast('خطأ في إرسال طلب الإيداع', 'error');
            } finally {
                loading.style.display = 'none';
            }
        });

        document.getElementById('vodafoneDepositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const phone = document.getElementById('vodafonePhone').value;
            const amount = parseFloat(document.getElementById('vodafoneAmount').value);
            const transaction = document.getElementById('vodafoneTransaction').value;
            const loading = document.getElementById('vodafoneLoading');
            
            loading.style.display = 'inline-block';
            
            try {
                // In a real implementation, this would call a Cloud Function
                // For demo purposes, we'll simulate the deposit
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showToast('تم إرسال طلب الإيداع، سيتم المراجعة قريباً', 'success');
                document.getElementById('vodafoneDepositForm').reset();
            } catch (error) {
                showToast('خطأ في إرسال طلب الإيداع', 'error');
            } finally {
                loading.style.display = 'none';
            }
        });

        // Admin functions
        window.switchAdminTab = function(tab) {
            document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.admin-tab:nth-child(${['products', 'orders', 'users', 'settings', 'stats'].indexOf(tab) + 1})`).classList.add('active');
            
            document.querySelectorAll('.admin-content').forEach(content => content.style.display = 'none');
            document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
            
            if (tab === 'products') loadAdminProducts();
            if (tab === 'orders') loadAdminOrders();
            if (tab === 'users') loadAdminUsers();
            if (tab === 'stats') loadAdminStats();
        };

        // Add product form handler
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                title: document.getElementById('productTitle').value,
                type: document.getElementById('productType').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                currency: document.getElementById('productCurrency').value,
                stock: parseInt(document.getElementById('productStock').value) || null,
                visible: document.getElementById('productVisible').value === 'true',
                adminFields: [],
                createdAt: serverTimestamp()
            };
            
            try {
                await addDoc(collection(db, 'products'), productData);
                showToast('تم إضافة المنتج بنجاح', 'success');
                document.getElementById('addProductForm').reset();
                loadAdminProducts();
                loadProducts(); // Refresh user products
            } catch (error) {
                showToast('خطأ في إضافة المنتج: ' + error.message, 'error');
            }
        });

        // Load admin products
        async function loadAdminProducts() {
            try {
                const querySnapshot = await getDocs(collection(db, 'products'));
                const productsList = document.getElementById('adminProductsList');
                productsList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const product = { id: doc.id, ...doc.data() };
                    const productItem = createAdminProductItem(product);
                    productsList.appendChild(productItem);
                });
            } catch (error) {
                console.error('Error loading admin products:', error);
            }
        }

        // Create admin product item
        function createAdminProductItem(product) {
            const item = document.createElement('div');
            item.className = 'card';
            item.style.marginBottom = '1rem';
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4>${product.title}</h4>
                        <p>${product.description}</p>
                        <p><strong>${product.price} ${product.currency}</strong></p>
                        <p>النوع: ${product.type} | المخزون: ${product.stock || 'غير محدود'} | مرئي: ${product.visible ? 'نعم' : 'لا'}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-warning" onclick="editProduct('${product.id}')">تعديل</button>
                        <button class="btn btn-error" onclick="deleteProduct('${product.id}')">حذف</button>
                    </div>
                </div>
            `;
            
            return item;
        }

        // Delete product
        window.deleteProduct = async function(productId) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                try {
                    await deleteDoc(doc(db, 'products', productId));
                    showToast('تم حذف المنتج بنجاح', 'success');
                    loadAdminProducts();
                    loadProducts();
                } catch (error) {
                    showToast('خطأ في حذف المنتج: ' + error.message, 'error');
                }
            }
        };

        // Load admin orders
        async function loadAdminOrders() {
            try {
                const ordersQuery = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));
                onSnapshot(ordersQuery, (querySnapshot) => {
                    const ordersList = document.getElementById('adminOrdersList');
                    ordersList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const order = { id: doc.id, ...doc.data() };
                        const orderItem = createAdminOrderItem(order);
                        ordersList.appendChild(orderItem);
                    });
                });
            } catch (error) {
                console.error('Error loading admin orders:', error);
            }
        }

        // Create admin order item
        function createAdminOrderItem(order) {
            const item = document.createElement('div');
            item.className = 'card';
            item.style.marginBottom = '1rem';
            
            const statusLabels = {
                pending: 'في الانتظار',
                processing: 'قيد المعالجة',
                completed: 'مكتمل',
                cancelled: 'ملغي'
            };
            
            item.innerHTML = `
                <div>
                    <h4>طلب #${order.id.substring(0, 8)}</h4>
                    <p><strong>المستخدم:</strong> ${order.userId}</p>
                    <p><strong>المنتج:</strong> ${order.productId}</p>
                    <p><strong>السعر:</strong> ${order.price} ${order.currency}</p>
                    <p><strong>الحالة:</strong> ${statusLabels[order.status]}</p>
                    <p><strong>التفاصيل:</strong> ${order.details || 'لا توجد تفاصيل'}</p>
                    
                    <div style="margin: 1rem 0;">
                        <label class="form-label">تغيير الحالة:</label>
                        <select class="form-select" onchange="updateOrderStatus('${order.id}', this.value)" style="width: auto; display: inline-block; margin-left: 1rem;">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>في الانتظار</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>قيد المعالجة</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ملغي</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="form-label">ملاحظات الإدارة:</label>
                        <textarea class="form-textarea" id="adminNotes_${order.id}" placeholder="أضف ملاحظات...">${order.adminNotes || ''}</textarea>
                        <button class="btn btn-primary" onclick="updateOrderNotes('${order.id}')" style="margin-top: 0.5rem;">حفظ الملاحظات</button>
                    </div>
                </div>
            `;
            
            return item;
        }

        // Update order status
        window.updateOrderStatus = async function(orderId, newStatus) {
            try {
                await updateDoc(doc(db, 'orders', orderId), {
                    status: newStatus
                });
                showToast('تم تحديث حالة الطلب', 'success');
            } catch (error) {
                showToast('خطأ في تحديث الحالة: ' + error.message, 'error');
            }
        };

        // Update order notes
        window.updateOrderNotes = async function(orderId) {
            const notes = document.getElementById(`adminNotes_${orderId}`).value;
            
            try {
                await updateDoc(doc(db, 'orders', orderId), {
                    adminNotes: notes
                });
                showToast('تم حفظ الملاحظات', 'success');
            } catch (error) {
                showToast('خطأ في حفظ الملاحظات: ' + error.message, 'error');
            }
        };

        // Load admin users
        async function loadAdminUsers() {
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                const usersList = document.getElementById('adminUsersList');
                usersList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const user = { id: doc.id, ...doc.data() };
                    const userItem = createAdminUserItem(user);
                    usersList.appendChild(userItem);
                });
            } catch (error) {
                console.error('Error loading admin users:', error);
            }
        }

        // Create admin user item
        function createAdminUserItem(user) {
            const item = document.createElement('div');
            item.className = 'card';
            item.style.marginBottom = '1rem';
            
            item.innerHTML = `
                <div>
                    <h4>${user.displayName || user.username}</h4>
                    <p><strong>اسم المستخدم:</strong> ${user.username}</p>
                    <p><strong>الدور:</strong> ${user.role}</p>
                    <p><strong>محقق:</strong> ${user.verified ? 'نعم' : 'لا'}</p>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn ${user.verified ? 'btn-warning' : 'btn-success'}" onclick="toggleUserVerification('${user.id}', ${!user.verified})">
                            ${user.verified ? 'إلغاء التحقق' : 'تحقق'}
                        </button>
                        <button class="btn btn-primary" onclick="editUserBalance('${user.id}')">تعديل الرصيد</button>
                    </div>
                </div>
            `;
            
            return item;
        }

        // Toggle user verification
        window.toggleUserVerification = async function(userId, verified) {
            try {
                await updateDoc(doc(db, 'users', userId), {
                    verified: verified
                });
                showToast(`تم ${verified ? 'تحقق' : 'إلغاء تحقق'} المستخدم`, 'success');
                loadAdminUsers();
            } catch (error) {
                showToast('خطأ في تحديث حالة التحقق: ' + error.message, 'error');
            }
        };

        // Edit user balance
        window.editUserBalance = async function(userId) {
            const newBalance = prompt('أدخل الرصيد الجديد:');
            if (newBalance !== null && !isNaN(newBalance)) {
                try {
                    await update(ref(rtdb, `balances/${userId}`), {
                        balance: parseFloat(newBalance)
                    });
                    showToast('تم تحديث الرصيد بنجاح', 'success');
                } catch (error) {
                    showToast('خطأ في تحديث الرصيد: ' + error.message, 'error');
                }
            }
        };

        // Load admin stats
        function loadAdminStats() {
            const statsRef = ref(rtdb, 'stats/global');
            onValue(statsRef, (snapshot) => {
                const stats = snapshot.val() || {};
                
                document.getElementById('activeUsersCount').value = stats.activeUsers || 33000;
                document.getElementById('totalOrdersCount').value = stats.totalOrders || 125000;
                document.getElementById('dailyOrdersCount').value = stats.dailyOrders || 1250;
                
                const liveStats = document.getElementById('liveStats');
                liveStats.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number">${(stats.activeUsers || 33000).toLocaleString()}</div>
                        <div class="stat-label">مستخدم نشط</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${(stats.totalOrders || 125000).toLocaleString()}</div>
                        <div class="stat-label">إجمالي الطلبات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${(stats.dailyOrders || 1250).toLocaleString()}</div>
                        <div class="stat-label">طلبات اليوم</div>
                    </div>
                `;
            });
        }

        // Update stats form handler
        document.getElementById('updateStatsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const activeUsers = parseInt(document.getElementById('activeUsersCount').value);
            const totalOrders = parseInt(document.getElementById('totalOrdersCount').value);
            const dailyOrders = parseInt(document.getElementById('dailyOrdersCount').value);
            
            try {
                await update(ref(rtdb, 'stats/global'), {
                    activeUsers: activeUsers,
                    totalOrders: totalOrders,
                    dailyOrders: dailyOrders
                });
                
                // Update footer stats
                updateFooterStats(activeUsers, totalOrders, dailyOrders);
                
                showToast('تم تحديث الإحصائيات بنجاح', 'success');
            } catch (error) {
                showToast('خطأ في تحديث الإحصائيات: ' + error.message, 'error');
            }
        });

        // Update footer stats
        function updateFooterStats(activeUsers, totalOrders, dailyOrders) {
            document.getElementById('footerActiveUsers').textContent = activeUsers.toLocaleString();
            document.getElementById('footerTotalOrders').textContent = totalOrders.toLocaleString();
            document.getElementById('footerDailyOrders').textContent = dailyOrders.toLocaleString();
        }

        // Auto-increment stats (fake animation)
        function startStatsAnimation() {
            setInterval(() => {
                const activeUsersEl = document.getElementById('footerActiveUsers');
                const totalOrdersEl = document.getElementById('footerTotalOrders');
                const dailyOrdersEl = document.getElementById('footerDailyOrders');
                
                if (activeUsersEl) {
                    const current = parseInt(activeUsersEl.textContent.replace(/,/g, ''));
                    activeUsersEl.textContent = (current + Math.floor(Math.random() * 3)).toLocaleString();
                }
                
                if (totalOrdersEl) {
                    const current = parseInt(totalOrdersEl.textContent.replace(/,/g, ''));
                    totalOrdersEl.textContent = (current + Math.floor(Math.random() * 2)).toLocaleString();
                }
                
                if (dailyOrdersEl) {
                    const current = parseInt(dailyOrdersEl.textContent.replace(/,/g, ''));
                    dailyOrdersEl.textContent = (current + Math.floor(Math.random() * 2)).toLocaleString();
                }
            }, 5000);
        }

        // Start stats animation
        startStatsAnimation();

        // Utility functions
        window.showToast = function(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        window.showSection = function(sectionName) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active');
        };

        function hideAllSections() {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        }

        window.changeCurrency = function(currency) {
            currentCurrency = currency;
            document.querySelectorAll('.currency-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="changeCurrency('${currency}')"]`).classList.add('active');
            updateBalanceDisplay();
        };

        window.toggleTheme = function() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        window.logout = async function() {
            try {
                await signOut(auth);
                showToast('تم تسجيل الخروج بنجاح', 'success');
            } catch (error) {
                showToast('خطأ في تسجيل الخروج: ' + error.message, 'error');
            }
        };

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);

        // Initialize stats listener
        const statsRef = ref(rtdb, 'stats/global');
        onValue(statsRef, (snapshot) => {
            const stats = snapshot.val();
            if (stats) {
                updateFooterStats(stats.activeUsers || 33000, stats.totalOrders || 125000, stats.dailyOrders || 1250);
            }
        });

    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98915a79408de183',t:'MTc1OTU0NjAzNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
