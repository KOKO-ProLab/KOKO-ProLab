
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="page_title">KOKO ProLab</title>
    <style>
        /* ... existing styles ... */
        .balance { font-weight: bold; color: var(--success-color); }
        .header-right .icon-btn {
            font-size: 1.8rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <div class="logo">KOKO ProLab</div>
        </div>
        <div class="header-right">
            <div id="user-status-container" class="user-status"></div>
            <button id="add-money-btn" class="icon-btn" style="display:none;">ðŸ’°</button>
            <button id="theme-toggle" class="icon-btn">ðŸŒ™</button>
            <button id="lang-toggle" class="icon-btn">AR</button>
        </div>
    </header>

    <main> <!-- ... existing main content ... --> </main>

    <!-- All Modals -->
    <div id="auth-modal" class="modal">...</div>
    <div id="username-modal" class="modal">
        <div class="modal-content">
            <h3 data-lang-key="set_username_title">Set Your Username</h3>
            <p data-lang-key="set_username_desc">Choose a unique username to complete your registration.</p>
            <div class="form-group"><label for="new-username" data-lang-key="username">Username</label><input type="text" id="new-username"></div>
            <button id="save-username-btn" class="btn btn-primary" data-lang-key="save_username">Save</button>
            <p id="username-error" class="error-message"></p>
        </div>
    </div>
    <div id="deposit-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3 data-lang-key="deposit_funds">Deposit Funds</h3>
            <div id="payment-instructions-display" style="margin-bottom: 1.5rem; white-space: pre-wrap; background: var(--background); padding: 1rem; border-radius: 8px;"></div>
            <form id="deposit-form">
                <div class="form-group"><label for="deposit-amount" data-lang-key="deposit_amount">Amount (USD)</label><input type="number" id="deposit-amount" required min="1"></div>
                <div class="form-group"><label for="deposit-method" data-lang-key="payment_method">Payment Method</label><input type="text" id="deposit-method" placeholder="e.g., PayPal, Bank Transfer ID" required></div>
                <button type="submit" class="btn btn-primary" data-lang-key="submit_deposit">Submit Request</button>
                <p id="deposit-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // --- Firebase & Translations Init ---
        const firebaseConfig = { apiKey: "AIzaSyDUaSnYinH910wp3zDHOCNuqWp9QjwIRow", authDomain: "koko-prolab.firebaseapp.com", projectId: "koko-prolab" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        const translations = { /* ... translations ... */ };

        document.addEventListener('DOMContentLoaded', () => {
            // --- MODAL & UI HANDLERS ---
            const authModal = document.getElementById('auth-modal');
            const usernameModal = document.getElementById('username-modal');
            const depositModal = document.getElementById('deposit-modal');
            document.querySelectorAll('.modal-backdrop, .close-modal-btn').forEach(el => el.addEventListener('click', () => {
                authModal.classList.remove('active');
                depositModal.classList.remove('active');
            }));
            
            // --- AUTH STATE LOGIC ---
            auth.onAuthStateChanged(user => {
                const addMoneyBtn = document.getElementById('add-money-btn');
                if (user) {
                    db.collection('users').doc(user.uid).onSnapshot(doc => {
                        if (!doc.exists) return; // Wait for user doc creation
                        const userData = doc.data();
                        if (!userData.username) {
                            usernameModal.classList.add('active');
                        } else {
                            usernameModal.classList.remove('active');
                            updateUserInfo(userData);
                            addMoneyBtn.style.display = 'block';
                        }
                    });
                } else {
                    updateUserInfo(null);
                    addMoneyBtn.style.display = 'none';
                }
            });

            // --- AUTH ACTIONS (REPAIRED) ---
            document.getElementById('login-btn').addEventListener('click', () => { /* ... corrected logic ... */ });
            document.getElementById('signup-btn').addEventListener('click', () => { /* ... corrected logic ... */ });
            document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
            document.getElementById('save-username-btn').addEventListener('click', saveUsername);

            async function handleGoogleSignIn() {
                try {
                    const result = await auth.signInWithPopup(googleProvider);
                    const user = result.user;
                    const userRef = db.collection('users').doc(user.uid);
                    const doc = await userRef.get();
                    if (!doc.exists) {
                        await userRef.set({ email: user.email, displayName: user.displayName, role: 'user', balance: 0, created_at: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                } catch (error) { console.error(error); }
            }
            
            async function saveUsername() {
                 const username = document.getElementById('new-username').value.trim();
                 const errorEl = document.getElementById('username-error');
                 if (username.length < 3) { errorEl.textContent = 'Username must be at least 3 characters.'; return; }
                 const query = await db.collection('users').where('username', '==', username).get();
                 if (!query.empty) { errorEl.textContent = 'This username is already taken.'; return; }
                 await db.collection('users').doc(auth.currentUser.uid).update({ username: username });
            }

            // --- DEPOSIT SYSTEM ---
            document.getElementById('add-money-btn').addEventListener('click', async () => {
                const settingsDoc = await db.collection('settings').doc('site').get();
                document.getElementById('payment-instructions-display').textContent = settingsDoc.data()?.payment_instructions || 'No instructions provided.';
                depositModal.classList.add('active');
            });

            document.getElementById('deposit-form').addEventListener('submit', async e => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('deposit-amount').value);
                const method = document.getElementById('deposit-method').value;
                await db.collection('deposits').add({ user_uid: auth.currentUser.uid, amount, method, status: 'pending', created_at: firebase.firestore.FieldValue.serverTimestamp() });
                depositModal.classList.remove('active');
                alert('Deposit request submitted!');
            });
            
            function updateUserInfo(userData) {
                const userStatusContainer = document.getElementById('user-status-container');
                if (userData) {
                     userStatusContainer.innerHTML = `<div class="user-info">${userData.username} <span class="balance">($${(userData.balance || 0).toFixed(2)})</span></div><a href="profile.html" class="btn">Profile</a><button id="logout-btn" class="btn btn-secondary">Logout</button>`;
                     document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                } else {
                     userStatusContainer.innerHTML = '<button id="login-modal-btn" class="btn btn-primary">Login</button>';
                     document.getElementById('login-modal-btn').addEventListener('click', () => authModal.classList.add('active'));
                }
            }
        });
    </script>
</body>
</html>
