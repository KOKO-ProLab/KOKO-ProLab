<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - KOKO ProLab</title>
    <style>
        :root { --primary-color: #3d5afe; --primary-light: #e3e8ff; --secondary-color: #ff4081; --background-light: #f5f7fa; --surface-light: #ffffff; --text-light: #212121; --border-color: #e0e0e0; --font-family: 'Segoe UI', sans-serif; --border-radius: 8px; }
        body { font-family: var(--font-family); background-color: var(--background-light); color: var(--text-light); margin: 0; display: flex; height: 100vh; }
        #admin-container { display: flex; width: 100%; height: 100%; }
        #admin-sidebar { width: 250px; background-color: var(--surface-light); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; }
        #admin-sidebar h1 { color: var(--primary-color); margin: 0 0 2rem 0; font-size: 1.8rem; }
        #admin-sidebar nav a { display: block; padding: 0.8rem 1rem; text-decoration: none; color: var(--text-light); font-weight: 600; border-radius: var(--border-radius); margin-bottom: 0.5rem; transition: background-color 0.2s; }
        #admin-sidebar nav a:hover, #admin-sidebar nav a.active { background-color: var(--primary-color); color: white; }
        #admin-main { flex: 1; padding: 2rem; overflow-y: auto; }
        .page { display: none; } .page.active { display: block; }
        #loading, #unauthorized { display: flex; justify-content: center; align-items: center; height: 100%; width: 100%; flex-direction: column; text-align: center; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-secondary { background-color: #6c757d; color: white; }
        .metric-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--surface-light); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card .value { font-size: 2rem; font-weight: bold; color: var(--primary-color); }
        table { width: 100%; border-collapse: collapse; background: var(--surface-light); box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: var(--border-radius); overflow: hidden; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--primary-light); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; }
        .modal-backdrop { position: absolute; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
        .modal-content { position: relative; background: var(--surface-light); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; }
    </style>
</head>
<body>
    <div id="loading"><div class="loader"></div><p>Verifying Access...</p></div>
    <div id="unauthorized" style="display: none;"><h2>Access Denied</h2><p>Redirecting...</p></div>
    <div id="admin-container" style="display: none;">
        <aside id="admin-sidebar">
            <h1>KOKO ProLab</h1>
            <nav>
                <a href="#" class="nav-link active" data-page="dashboard">Dashboard</a>
                <a href="#" class="nav-link" data-page="products">Products</a>
                <a href="#" class="nav-link" data-page="orders">Orders</a>
                <a href="#" class="nav-link" data-page="users">Users</a>
                <a href="#" class="nav-link" data-page="settings">Settings</a>
            </nav>
            <div id="admin-user-info" class="user-info"></div>
        </aside>
        <main id="admin-main">
            <section id="dashboard" class="page active"><h2>Dashboard</h2><div class="metric-cards"><div class="card"><h3>Total Users</h3><div id="metric-total-users" class="value">0</div></div><div class="card"><h3>Total Orders</h3><div id="metric-total-orders" class="value">0</div></div><div class="card"><h3>Pending Orders</h3><div id="metric-pending-orders" class="value">0</div></div></div></section>
            <section id="products" class="page"><h2>Product Management</h2></section>
            <section id="orders" class="page"><h2>Order Management</h2><table id="orders-table"><thead><tr><th>User</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></section>
            <section id="users" class="page"><h2>User Management</h2><table id="users-table"><thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Balance</th><th>Actions</th></tr></thead><tbody></tbody></table></section>
            <section id="settings" class="page"><h2>Site Settings</h2><form id="settings-form"><div class="form-group"><label for="payment-instructions">Payment Instructions</label><textarea id="payment-instructions" rows="6"></textarea></div><button type="submit" class="btn btn-primary">Save Settings</button></form></section>
        </main>
    </div>
    <div id="user-edit-modal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><h3>Edit User</h3><form id="user-edit-form"><input type="hidden" id="edit-user-id"><div class="form-group"><label>Username</label><input type="text" id="edit-username" disabled></div><div class="form-group"><label>Email</label><input type="email" id="edit-email" disabled></div><div class="form-group"><label for="edit-display-name">Display Name</label><input type="text" id="edit-display-name"></div><div class="form-group"><label for="edit-phone">Phone</label><input type="tel" id="edit-phone"></div><div class="form-group"><label for="edit-role">Role</label><select id="edit-role"><option value="user">User</option><option value="admin">Admin</option></select></div><hr><h4>Adjust Balance</h4><div class="form-group"><label for="edit-balance-adjustment">Amount to Add/Subtract</label><input type="number" id="edit-balance-adjustment" step="0.01"><p>Current Balance: <strong id="current-balance">$0.00</strong></p></div><button type="submit" class="btn btn-primary">Save Changes</button></form></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDUaSnYinH910wp3zDHOCNuqWp9QjwIRow", authDomain: "koko-prolab.firebaseapp.com", projectId: "koko-prolab" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (!user) return showUnauthorized();
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().role === 'admin') {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('admin-container').style.display = 'flex';
                        setupAdminPanel(user, doc.data());
                    } else { showUnauthorized(); }
                }).catch(showUnauthorized);
            });
        });

        function showUnauthorized() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('unauthorized').style.display = 'flex';
            setTimeout(() => { window.location.href = 'index.html'; }, 2000);
        }

        function setupAdminPanel(user, userData) {
            document.getElementById('admin-user-info').innerHTML = `<p><strong>${userData.username}</strong></p><a href="#" id="admin-logout">Logout</a>`;
            document.getElementById('admin-logout').addEventListener('click', e => { e.preventDefault(); auth.signOut(); });
            handleNavigation();
            loadDashboardMetrics();
            loadProducts();
            loadOrders();
            loadUsers();
            loadSettings();
        }

        function handleNavigation() { /* ... as before ... */ }
        function loadDashboardMetrics() { /* ... as before ... */ }
        function loadProducts() { /* ... as before ... */ }
        function loadOrders() { /* ... as before ... */ }
        
        function loadUsers() {
            const usersTableBody = document.querySelector('#users-table tbody');
            db.collection('users').onSnapshot(snap => {
                usersTableBody.innerHTML = '';
                snap.forEach(doc => {
                    const user = doc.data();
                    const row = usersTableBody.insertRow();
                    row.innerHTML = `<td>${user.username}</td><td>${user.email}</td><td>${user.role}</td><td>$${(user.balance || 0).toFixed(2)}</td>
                        <td><button class="btn btn-primary edit-user-btn" data-id="${doc.id}">Edit</button></td>`;
                });
            });

            usersTableBody.addEventListener('click', async e => {
                if (e.target.classList.contains('edit-user-btn')) {
                    const userId = e.target.dataset.id;
                    const doc = await db.collection('users').doc(userId).get();
                    const user = doc.data();
                    document.getElementById('edit-user-id').value = userId;
                    document.getElementById('edit-username').value = user.username;
                    document.getElementById('edit-email').value = user.email;
                    document.getElementById('edit-display-name').value = user.displayName || '';
                    document.getElementById('edit-phone').value = user.phone || '';
                    document.getElementById('edit-role').value = user.role;
                    document.getElementById('current-balance').textContent = `$${(user.balance || 0).toFixed(2)}`;
                    document.getElementById('user-edit-modal').classList.add('active');
                }
            });
        }

        document.querySelector('#user-edit-modal .modal-backdrop').addEventListener('click', () => document.getElementById('user-edit-modal').classList.remove('active'));

        document.getElementById('user-edit-form').addEventListener('submit', async e => {
            e.preventDefault();
            const userId = document.getElementById('edit-user-id').value;
            const adjustment = parseFloat(document.getElementById('edit-balance-adjustment').value) || 0;

            const updateData = {
                displayName: document.getElementById('edit-display-name').value,
                phone: document.getElementById('edit-phone').value,
                role: document.getElementById('edit-role').value,
                balance: firebase.firestore.FieldValue.increment(adjustment)
            };

            await db.collection('users').doc(userId).update(updateData);
            document.getElementById('user-edit-modal').classList.remove('active');
            document.getElementById('edit-balance-adjustment').value = ''; // Clear adjustment field
        });

        function loadSettings() {
            const settingsForm = document.getElementById('settings-form');
            const paymentInstructions = document.getElementById('payment-instructions');
            const settingsRef = db.collection('settings').doc('site');

            settingsRef.get().then(doc => {
                if(doc.exists) paymentInstructions.value = doc.data().payment_instructions || '';
            });

            settingsForm.addEventListener('submit', async e => {
                e.preventDefault();
                await settingsRef.set({ payment_instructions: paymentInstructions.value }, { merge: true });
                alert('Settings saved!');
            });
        }
    </script>
</body>
</html>
